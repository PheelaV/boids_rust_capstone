---
title: "Boidr analysis"
output:
  pdf_document:
    highlight: tango
---

Load libraries, install boidr
```{r}
library(tidyr)
library(dplyr)
library(ggplot2)
library(tictoc)
# there is a bug, need to be installed from github to use the latest version: remotes::install_github("extendr/rextendr")
library(rextendr)
setwd("~/Source/Repos/boids_rust/boidr")


rextendr::document()
devtools::load_all(".")
# this is loud
invisible({capture.output({


})})

# data_folder <- "~/Source/Repos/boids_rust/boidranalysis/Data/"
data_folder <- "./Data/"
```
```{r}
source("./R/helpers.R")
source("./R/directions_angles.R")
```

get flocking data
```{r}
# boid_data <- flock_return(no_iter = 8000, init_boids = 256, save_locations_path = data_folder, sample_rate = 8, init_width = 4000, init_height = 4000)
boid_data <- flock_detailed(no_iter = 8000,
                             init_boids = 512,
                             save_locations_path = "", # data_folder,
                             sample_rate = 32,
                             init_width = 4000, 
                             init_height = 4000, 
                             sensory_distance = 50,
                             allignment_coef = .02,
                             allignment_trs_coef = 1.15,
                             cohesion_coef = 0.002, 
                             cohesion_trs_coef = .95,
                             separation_coef = 4.1,
                             separation_trs_coef = .3,
                             min_speed = .5,
                             max_speed = 2.,
                             max_steering = .65,
                             dbscan_clustering = T,
                             boundary_config = "{\"type\": \"Thoroidal\"}"
                             # boundary_config = "{\"type\": \"Repulsive\", \"distance\": 100, \"force\": 0.05}"
                            ) %>%
    tibble()
```
visualize
```{r}
direction_data_by_boid <- boid_data %>%
  group_by(id) %>%
  reframe(
    id = id[2:n()],
    headings = get_headings(x, y),
    x = x[2:n()],
    y = y[2:n()],
    cluster_id = cluster_id[2:n()],
    time = time[2:n()]
  ) %>%
  reframe(
    id = id[2:n()],
    bearings = get_bearings(headings),
    # as bearings are calculated from pairs, to map them one to one, throw away the headings of t_0 to match lengths
    headings = headings[2:length(headings)],
    x = x[2:n()],
    y = y[2:n()],
    cluster_id = cluster_id[2:n()],
    time = time[2:n()]
  ) %>%
  slice(-tail(
    remove_boundary_data(boid_data, sensory_distance, init_width, init_height, time_dependency),
    -2
  ))

hull_areas <- direction_data_by_boid %>%
  group_by(time, cluster_id) %>%
  summarise(hull_area = get_convex_hull(x, y))

print("range of bearings:")
range(direction_data_by_boid$bearings)

print("range of headings:")
range(direction_data_by_boid$headings)

headings_binned <- direction_data_by_boid %>%
  mutate(
    headings = floor(rad2deg(headings))
  ) %>%
  group_by(headings) %>%
  summarise(
    count = length(id)
  ) %>%
  select(heading = headings, count = count)

bearings_binned <- direction_data_by_boid %>%
  mutate(
    bearings = floor(rad2deg(bearings))
  ) %>%
  group_by(bearings) %>%
  summarise(
    count = length(id)
  ) %>%
  select(bearing = bearings, count = count)

ggplot(headings_binned, aes(x = heading, y = log(count))) +
  coord_polar(theta = "x", start = pi) +
  geom_bar(stat = "identity", fill = "deeppink4", width = .9) +
  # geom_hline(yintercept = seq(0, 500, by = 100), color = "grey80", size = 0.3) +
  # scale_x_continuous(breaks = 0:24, expand = c(.002,0)) +
  labs(x = "Heading w.r.t N") +
  theme_bw()

summary(direction_data_by_boid %>% select(-id))

```
```{r}
ggplot(bearings_binned, aes(x = bearing, y = log(count))) +
  coord_polar(theta = "x", start = pi) +
  geom_bar(stat = "identity", fill = "deeppink4", width = .9) +
  # geom_hline(yintercept = seq(0, 500, by = 100), color = "grey80", size = 0.3) +
  # scale_x_continuous(breaks = 0:24, expand = c(.002,0)) +
  labs(x = "Bearing w.r.t N") +
  theme_bw()
```
The symmetry here is fascinating, after investigation I am confident in the bearings function. A naive explanation would be the boid's tendency to over react and then over correct, e.g., when it wants to avoid a boid in front of of him slightly on the left, it will turn abruptly to the right, then starts to be attracted again towards the same boid.
```{r}
ggplot(direction_data_by_boid, aes(x=headings)) +
    # coord_polar(theta = "x", start = pi) +
geom_density(color="aquamarine4", fill="aquamarine3") +
  theme_bw()
```
```{r}
ggplot(direction_data_by_boid, aes(x=bearings)) +
  geom_density(color="aquamarine4", fill="aquamarine3") +
  theme_bw()
```


```{r}

ggplot(headings_binned) +
  geom_col(aes(x = heading, y = log(count))) +
  scale_x_continuous(
    breaks = seq(-180, 179, 45),
    minor_breaks = seq(-180, 179, 15)
  ) +
  # coord_polar() +
  coord_polar(theta = "x", start = pi) +
  theme_bw()
ggplot(headings_binned) +
  geom_col(aes(x = heading, y = count)) +
  scale_x_continuous(
    breaks = seq(-180, 179, 45),
    minor_breaks = seq(-180, 179, 15)
  ) +
  # coord_polar() +
  coord_polar(theta = "x", start = pi) +
  theme_bw()
```

